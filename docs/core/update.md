
# 应用开发和发布流程更新

## 应用模型

开发者在应用开发列表创建**应用组件**之后，可以给此组件添加**开发数据库**和设置**开发应用程序**，在开发界面内调用的数据都是来自**开发数据库**。

应用组件默认处于未发布状态，普通商家不可见、不可使用，只有担路网员工可见、可以使用，应用发布之后所有人都可以使用。

商家从应用列表第一次添加某应用时会创建一条记录关联应用与商家，并克隆开发数据库作为商家的数据库。商家第二次添加某应用时，不会重新创建数据库。也就是说，对于一个商家而言，一个应用只有一个数据库。

## 问题

从上面的应用模型可以发现很多问题，比如：

- 假设商家添加好了应用，开发者又更新了前端代码，这时候的行为是怎么样的？
- 假设我给数据库新增/删除了几个表/字段，商家数据库会更新吗？
- 美工需要增加几个样式选项，怎么办？
- 云代码更新了怎么办？

## 方案

- 应用代码只有一份：系统保证用户每次编辑应用/应用在商家网站打开/应用在个人中心打开时，代码始终是最新的
- 云代码只有一份
- 自定义选项自动合并
  - 同步新增：开发者编辑组件后加上了两个选项，**会**自动同步到所有基于此组件创建的应用
  - 同步删除：开发者编辑组件删除选项，**会**同步删除所有基于此组件创建的应用
  - **更新**：开发者修改了组件的值，**不会**同步到以前基于此组件创建的应用
- 数据库策略见下面

## 数据库的更新策略

未发布应用时：假设开发者给数据库修改了字段，并不会自动同步到所有基于此组件创建的应用，需要开发者手动点击**数据库管理/执行 migrate**，执行之后会同步数据库修改，同步策略：

![](https://s2.d2scdn.com/2017/10/25/a1a0fbf2-e9c2-4679-a810-6b4289d76d1b/Jietu20171025-153522.png)

- 新建表：完全复制表结构，但是不复制表数据
- 删除表：同步删除表
- 修改表：同步修改表字段，并且根据表字段更新所有数据行，更新策略：
  - 新建字段：自动给旧字段添加默认值
  - 删除字段：删除字段
  - 修改字段类型：**警告**！请不要修改字段类型，如果需要修改，建议换字段名字

已发布应用参考下一节

## 应用发布流程

应用在未发布状态测试完成之后，可以点击发布变成发布状态。如果应用发布之后开发者继续修改应用代码，会怎么样？根据上面的模型，代码只有一份，代码实时更新，这意味着在开发时写错一行代码，也会被实时更新到商家的网站，这不合理。所以在应用发布之后，**禁止直接修改**。

如果需要修改已发布的应用，需要先**克隆**应用，因为克隆的应用属于未发布的应用，未发布的应用可以很方便的随意调试，修改完未发布应用，再通过应用更新工具更新到上级组件。

![](https://s2.d2scdn.com/2017/10/25/f6c58a3e-cd85-4669-952d-011c1b0f86af/Jietu20171025-153206.png)

更新策略：

- 把子组件的元数据合并到父组件
- 把子组件的前端代码合并到父组件
- 把子组件的数据集 migrate 到父组件
- 父组件的数据集 migrate 到父组件关联的所有页面
- 把子组件的云代码合并到父组件
- 刷新父组件关联的所有页面的缓存

## 运维工具

新增商家使用列表用来查看所有添加了当前组件的商家

![](https://s2.d2scdn.com/2017/10/25/f34d48df-6d07-4642-88a8-f50be9618ecb/Jietu20171025-153705.png)

## 一些限制

- [x] 不能克隆带系统表单应用
- [x] 只能在 web_pc 和 web_mobile 使用路由 dui-router
- [x] user_mobile 和 user_pc 不能使用CSS选项
